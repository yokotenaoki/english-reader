<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Reader ‚Äî Ëã±ÊñáËß£Ë™¨„Ç¢„Éó„É™</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&family=Noto+Serif+JP:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1209;
    --paper: #f5f0e8;
    --paper-dark: #ede8dc;
    --accent: #8b2500;
    --accent-light: #c4430a;
    --gold: #b8860b;
    --muted: #7a6e5f;
    --border: #d4cbbf;
    --panel-bg: #faf7f2;
  }

  body {
    font-family: 'Source Serif 4', Georgia, serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    padding: 0;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      repeating-linear-gradient(transparent, transparent 27px, rgba(180,160,120,0.12) 28px),
      radial-gradient(ellipse at 20% 0%, rgba(200,180,140,0.3) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(180,160,120,0.2) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .masthead {
    text-align: center;
    padding: 40px 20px 24px;
    border-bottom: 2px solid var(--ink);
    position: relative;
    z-index: 1;
  }

  .masthead-line {
    font-size: 11px;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 300;
    margin-bottom: 8px;
  }

  .masthead h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(36px, 6vw, 64px);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--ink);
  }

  .masthead h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .masthead-sub {
    font-family: 'Noto Serif JP', serif;
    font-size: 13px;
    color: var(--muted);
    margin-top: 10px;
    font-weight: 300;
    letter-spacing: 0.05em;
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px auto;
    max-width: 300px;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--ink);
  }

  .divider-ornament {
    font-size: 18px;
    color: var(--accent);
  }

  .main {
    max-width: 860px;
    margin: 0 auto;
    padding: 40px 24px 80px;
    position: relative;
    z-index: 1;
  }

  /* INPUT SECTION */
  .input-section {
    margin-bottom: 48px;
  }

  .section-label {
    font-family: 'Playfair Display', serif;
    font-size: 11px;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  textarea {
    width: 100%;
    min-height: 200px;
    padding: 20px 24px;
    font-family: 'Source Serif 4', serif;
    font-size: 16px;
    line-height: 1.75;
    color: var(--ink);
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    resize: vertical;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-weight: 300;
  }

  textarea:focus {
    border-color: var(--accent-light);
    box-shadow: 0 0 0 3px rgba(139, 37, 0, 0.08);
  }

  textarea::placeholder {
    color: var(--muted);
    font-style: italic;
    font-size: 15px;
  }

  .btn-analyze {
    margin-top: 16px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 14px 32px;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    position: relative;
    overflow: hidden;
  }

  .btn-analyze::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--accent);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .btn-analyze:hover::before { transform: translateX(0); }
  .btn-analyze span { position: relative; z-index: 1; }
  .btn-analyze:active { transform: translateY(1px); }

  .btn-clear {
    margin-top: 16px;
    margin-left: 12px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 14px 24px;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }

  .btn-clear:hover { color: var(--accent); border-color: var(--accent); }

  /* ARTICLE VIEW */
  .article-section { display: none; }
  .article-section.visible { display: block; }

  .article-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .para-count {
    font-size: 12px;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-transform: uppercase;
  }

  .paragraph-block {
    margin-bottom: 32px;
    position: relative;
  }

  .paragraph-wrapper {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .para-number {
    font-family: 'Playfair Display', serif;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 0.2em;
    min-width: 28px;
    padding-top: 6px;
    text-align: right;
    opacity: 0.7;
  }

  .para-text {
    flex: 1;
    font-size: 17px;
    line-height: 1.85;
    color: var(--ink);
    font-weight: 300;
    padding: 16px 20px;
    background: var(--panel-bg);
    border-left: 3px solid var(--border);
    transition: border-color 0.2s, background 0.2s;
  }

  .paragraph-block.active .para-text {
    border-left-color: var(--accent);
    background: #fff;
  }

  .btn-explain {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
    margin-left: 44px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 7px 18px;
    font-family: 'Noto Serif JP', serif;
    font-size: 12px;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .btn-explain:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .btn-explain.loading {
    color: var(--muted);
    border-style: dashed;
    pointer-events: none;
    animation: pulse 1.2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* EXPLANATION PANEL */
  .explanation-panel {
    margin-top: 16px;
    margin-left: 44px;
    background: white;
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.4s ease, opacity 0.3s ease;
    opacity: 0;
  }

  .explanation-panel.open {
    max-height: 2000px;
    opacity: 1;
  }

  .explanation-inner {
    padding: 28px 28px 24px;
  }

  .exp-section {
    margin-bottom: 24px;
  }

  .exp-section:last-child { margin-bottom: 0; }

  .exp-heading {
    font-family: 'Playfair Display', serif;
    font-size: 10px;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .exp-heading::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--paper-dark);
  }

  .exp-heading-icon {
    width: 20px;
    height: 20px;
    background: var(--accent);
    color: white;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    flex-shrink: 0;
  }

  .exp-content {
    font-family: 'Noto Serif JP', serif;
    font-size: 14.5px;
    line-height: 1.95;
    color: #2a2018;
    font-weight: 300;
  }

  .exp-content p { margin-bottom: 8px; }

  .grammar-item {
    display: flex;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--paper-dark);
  }

  .grammar-item:last-child { border-bottom: none; }

  .grammar-tag {
    font-family: 'Source Serif 4', serif;
    font-size: 11px;
    letter-spacing: 0.1em;
    color: white;
    background: var(--gold);
    padding: 2px 8px;
    height: fit-content;
    margin-top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .grammar-desc {
    font-family: 'Noto Serif JP', serif;
    font-size: 14px;
    line-height: 1.8;
    color: #2a2018;
    font-weight: 300;
  }

  .translation-box {
    background: var(--paper);
    border-left: 4px solid var(--gold);
    padding: 16px 20px;
    font-family: 'Noto Serif JP', serif;
    font-size: 15.5px;
    line-height: 2;
    color: var(--ink);
    font-weight: 400;
  }

  .error-msg {
    color: var(--accent);
    font-family: 'Noto Serif JP', serif;
    font-size: 13px;
    padding: 12px 16px;
    border: 1px solid rgba(139,37,0,0.3);
    background: rgba(139,37,0,0.04);
  }

  /* LOADING SPINNER */
  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Paragraph separator */
  .para-sep {
    width: 40px;
    height: 1px;
    background: var(--border);
    margin: 0 auto 32px;
  }

  .hint {
    font-family: 'Noto Serif JP', serif;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    margin-top: 12px;
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<header class="masthead">
  <div class="masthead-line">AI-Powered English Learning</div>
  <h1>English <em>Reader</em></h1>
  <div class="masthead-sub">Ëã±ÊñáË®ò‰∫ã„Çí„Éë„É©„Ç∞„É©„ÉïÂçò‰Ωç„ÅßÊ∑±„ÅèË™≠„ÅøËß£„Åè</div>
  <div class="divider"><span class="divider-ornament">‚ùß</span></div>
</header>

<main class="main">

  <!-- INPUT -->
  <section class="input-section" id="inputSection">
    <div class="section-label">Ëã±Êñá„ÇíË≤º„Çä‰ªò„Åë„Çã</div>
    <textarea id="articleInput" placeholder="Ëã±ÊñáË®ò‰∫ã„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éë„É©„Ç∞„É©„Éï„Åî„Å®„Å´Ëß£Ë™¨„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ"></textarea>
    <div>
      <button class="btn-analyze" onclick="analyzeArticle()">
        <span>‚ñ∂ Ë®ò‰∫ã„ÇíË™≠„ÅøËæº„ÇÄ</span>
      </button>
      <button class="btn-clear" onclick="clearAll()">‚úï „ÇØ„É™„Ç¢</button>
    </div>
    <p class="hint">Tip: Á©∫Ë°å„Åß„Éë„É©„Ç∞„É©„Éï„ÇíÂå∫Âàá„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p>
  </section>

  <!-- ARTICLE VIEW -->
  <section class="article-section" id="articleSection">
    <div class="article-meta">
      <span class="section-label" style="margin:0">Ëß£Ë™¨„É¢„Éº„Éâ</span>
      <span class="para-count" id="paraCount"></span>
    </div>
    <div id="paragraphsContainer"></div>
    <button class="btn-clear" style="margin-top:16px" onclick="clearAll()">‚Üê Âà•„ÅÆË®ò‰∫ã„ÇíË™≠„ÇÄ</button>
  </section>

</main>

<script>
const API_URL = "https://api.anthropic.com/v1/messages";

function analyzeArticle() {
  const text = document.getElementById('articleInput').value.trim();
  if (!text) return;

  const paragraphs = text.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 30);
  if (paragraphs.length === 0) {
    alert('ÊúâÂäπ„Å™„Éë„É©„Ç∞„É©„Éï„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇËã±Êñá„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return;
  }

  document.getElementById('inputSection').style.display = 'none';
  const articleSection = document.getElementById('articleSection');
  articleSection.classList.add('visible');
  document.getElementById('paraCount').textContent = `${paragraphs.length} paragraphs`;

  const container = document.getElementById('paragraphsContainer');
  container.innerHTML = '';

  paragraphs.forEach((para, idx) => {
    const block = document.createElement('div');
    block.className = 'paragraph-block';
    block.id = `block-${idx}`;

    block.innerHTML = `
      <div class="paragraph-wrapper">
        <div class="para-number">¬ß${idx + 1}</div>
        <div class="para-text">${escapeHtml(para)}</div>
      </div>
      <button class="btn-explain" id="btn-${idx}" onclick="explainParagraph(${idx}, this)">
        <span class="btn-label">üìñ „Åì„ÅÆ„Éë„É©„Ç∞„É©„Éï„ÇíËß£Ë™¨</span>
      </button>
      <div class="explanation-panel" id="panel-${idx}">
        <div class="explanation-inner" id="inner-${idx}"></div>
      </div>
      <div class="para-sep"></div>
    `;

    container.appendChild(block);
  });

  window._paragraphs = paragraphs;
}

async function explainParagraph(idx, btn) {
  const panel = document.getElementById(`panel-${idx}`);
  const inner = document.getElementById(`inner-${idx}`);
  const block = document.getElementById(`block-${idx}`);

  // Toggle if already open
  if (panel.classList.contains('open') && !btn.classList.contains('loading')) {
    panel.classList.remove('open');
    block.classList.remove('active');
    btn.querySelector('.btn-label').textContent = 'üìñ „Åì„ÅÆ„Éë„É©„Ç∞„É©„Éï„ÇíËß£Ë™¨';
    return;
  }

  // Already loaded ‚Äî just reopen
  if (inner.dataset.loaded === 'true') {
    panel.classList.add('open');
    block.classList.add('active');
    return;
  }

  btn.classList.add('loading');
  btn.querySelector('.btn-label').innerHTML = '<span class="spinner"></span> AI„ÅåËß£Êûê‰∏≠...';
  block.classList.add('active');

  const paragraph = window._paragraphs[idx];

  const prompt = `„ÅÇ„Å™„Åü„ÅØËã±Ë™ûÊïôÂ∏´„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆËã±Êñá„Éë„É©„Ç∞„É©„Éï„ÇíÊó•Êú¨‰∫∫Â≠¶ÁøíËÄÖÂêë„Åë„Å´Ë©≥„Åó„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêËã±Êñá„Äë
${paragraph}

‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂøÖ„ÅöËøîÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSON„ÅßËøî„Åï„Åö„ÄÅ„Åù„ÅÆ„Åæ„ÅæÊó•Êú¨Ë™û„ÅßÔºâÔºö

===ÂíåË®≥===
Ëá™ÁÑ∂„ÅßË™≠„Åø„ÇÑ„Åô„ÅÑÊó•Êú¨Ë™ûË®≥„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

===ÊßãÊñáËß£Êûê===
„Éë„É©„Ç∞„É©„Éï„ÅÆ‰∏ªË¶Å„Å™Êñá„Å´„Å§„ÅÑ„Å¶„ÄÅ‰∏ªË™û„ÉªÂãïË©û„ÉªÁõÆÁöÑË™û„Éª‰øÆÈ£æË™û„Å™„Å©„ÅÆÊßãÈÄ†„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË§áÊï∞„ÅÆÊñá„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂêÑÊñá„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

===Ëã±ÊñáÊ≥ï„ÅÆ„Éù„Ç§„É≥„Éà===
„Åì„ÅÆ„Éë„É©„Ç∞„É©„Éï„Åß‰Ωø„Çè„Çå„Å¶„ÅÑ„ÇãÈáçË¶Å„Å™ÊñáÊ≥ï‰∫ãÈ†Ö„Çí3„Äú5ÁÇπ„ÄÅÂÖ∑‰ΩìÁöÑ„Å™‰æãÊñáÁÆáÊâÄ„ÇíÂºïÁî®„Åó„Å™„Åå„ÇâË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂêÑ„Éù„Ç§„É≥„Éà„ÅØ„Äå„ÄêÊñáÊ≥ïÂêç„ÄëÔºöË™¨Êòé„Äç„ÅÆÂΩ¢Âºè„ÅßÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

===Ë™ûÂΩô„ÉªË°®Áèæ===
ÈáçË¶Å„Å™ÂçòË™û„Éª„Éï„É¨„Éº„Ç∫„Çí3„Äú5ÂÄãÈÅ∏„Å≥„ÄÅÊÑèÂë≥„Å®‰Ωø„ÅÑÊñπ„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);

    const responseText = data.content.map(b => b.text || '').join('');
    inner.innerHTML = renderExplanation(responseText);
    inner.dataset.loaded = 'true';
    panel.classList.add('open');

  } catch (err) {
    inner.innerHTML = `<div class="error-msg">‚ö† „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${err.message}</div>`;
    panel.classList.add('open');
  }

  btn.classList.remove('loading');
  btn.querySelector('.btn-label').textContent = '‚úï Èñâ„Åò„Çã';
}

function renderExplanation(text) {
  const sections = [
    { marker: '===ÂíåË®≥===', key: 'translation', icon: 'Ë®≥', title: 'ÂíåË®≥' },
    { marker: '===ÊßãÊñáËß£Êûê===', key: 'syntax', icon: 'Êßã', title: 'ÊßãÊñáËß£Êûê' },
    { marker: '===Ëã±ÊñáÊ≥ï„ÅÆ„Éù„Ç§„É≥„Éà===', key: 'grammar', icon: 'Êñá', title: 'Ëã±ÊñáÊ≥ï„ÅÆ„Éù„Ç§„É≥„Éà' },
    { marker: '===Ë™ûÂΩô„ÉªË°®Áèæ===', key: 'vocab', icon: 'Ë™û', title: 'Ë™ûÂΩô„ÉªË°®Áèæ' },
  ];

  const parts = {};
  sections.forEach((s, i) => {
    const start = text.indexOf(s.marker);
    if (start === -1) return;
    const contentStart = start + s.marker.length;
    const nextIdx = sections.slice(i + 1).map(ns => text.indexOf(ns.marker)).filter(x => x !== -1);
    const end = nextIdx.length > 0 ? Math.min(...nextIdx) : text.length;
    parts[s.key] = text.slice(contentStart, end).trim();
  });

  let html = '';

  if (parts.translation) {
    html += `
      <div class="exp-section">
        <div class="exp-heading"><span class="exp-heading-icon">Ë®≥</span>ÂíåË®≥</div>
        <div class="translation-box">${nl2p(parts.translation)}</div>
      </div>`;
  }

  if (parts.syntax) {
    html += `
      <div class="exp-section">
        <div class="exp-heading"><span class="exp-heading-icon">Êßã</span>ÊßãÊñáËß£Êûê</div>
        <div class="exp-content">${nl2p(parts.syntax)}</div>
      </div>`;
  }

  if (parts.grammar) {
    const lines = parts.grammar.split('\n').filter(l => l.trim());
    let grammarHtml = '';
    lines.forEach(line => {
      const m = line.match(/^„Äê(.+?)„Äë[Ôºö:]\s*(.+)/);
      if (m) {
        grammarHtml += `<div class="grammar-item"><span class="grammar-tag">${m[1]}</span><div class="grammar-desc">${m[2]}</div></div>`;
      } else if (line.trim()) {
        grammarHtml += `<div class="grammar-item"><div class="grammar-desc" style="padding-left:0">${line}</div></div>`;
      }
    });
    html += `
      <div class="exp-section">
        <div class="exp-heading"><span class="exp-heading-icon">Êñá</span>Ëã±ÊñáÊ≥ï„ÅÆ„Éù„Ç§„É≥„Éà</div>
        <div>${grammarHtml}</div>
      </div>`;
  }

  if (parts.vocab) {
    html += `
      <div class="exp-section">
        <div class="exp-heading"><span class="exp-heading-icon">Ë™û</span>Ë™ûÂΩô„ÉªË°®Áèæ</div>
        <div class="exp-content">${nl2p(parts.vocab)}</div>
      </div>`;
  }

  return html || `<div class="exp-content">${nl2p(text)}</div>`;
}

function nl2p(text) {
  return text.split('\n').filter(l => l.trim()).map(l => `<p>${escapeHtml(l)}</p>`).join('');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function clearAll() {
  document.getElementById('articleInput').value = '';
  document.getElementById('articleSection').classList.remove('visible');
  document.getElementById('inputSection').style.display = 'block';
  document.getElementById('paragraphsContainer').innerHTML = '';
  window._paragraphs = [];
}
</script>
</body>
</html>
